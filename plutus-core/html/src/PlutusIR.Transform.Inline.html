<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds  #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs            #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase       #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell  #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies     #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators    #-}</span><span>
</span><span id="line-8"></span><span class="hs-comment">{-|
An inlining pass.

Note that there is (essentially) a copy of this in the UPLC inliner, and the two
should be KEPT IN SYNC, so if you make changes here please either make them in the other
one too or add to the comment that summarises the differences.
-}</span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusIR.Transform.Inline</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#inline"><span class="hs-identifier">inline</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.InlineUtils.html#InlineHints"><span class="hs-identifier">InlineHints</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.html"><span class="hs-identifier">PlutusIR</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html"><span class="hs-identifier">PlutusIR.Analysis.Dependencies</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Deps</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html"><span class="hs-identifier">PlutusIR.Analysis.Usages</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Usages</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.MkPir.html"><span class="hs-identifier">PlutusIR.MkPir</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.MkPir.html#mkLet"><span class="hs-identifier">mkLet</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Purity.html"><span class="hs-identifier">PlutusIR.Purity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Purity.html#isPure"><span class="hs-identifier">isPure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Rename.html"><span class="hs-identifier">PlutusIR.Transform.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.html"><span class="hs-identifier">PlutusCore</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.InlineUtils.html"><span class="hs-identifier">PlutusCore.InlineUtils</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html"><span class="hs-identifier">PlutusCore.Quote</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Rename.html"><span class="hs-identifier">PlutusCore.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Rename.Internal.html#Dupable"><span class="hs-identifier">Dupable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier">dupable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Rename.html#liftDupable"><span class="hs-identifier">liftDupable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Subst.html"><span class="hs-identifier">PlutusCore.Subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Subst.html#typeSubstTyNamesM"><span class="hs-identifier">typeSubstTyNamesM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Strict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.Reader</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.State</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../algebraic-graphs/html/src"><span class="hs-identifier">Algebra.Graph</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../semigroups/html/src"><span class="hs-identifier">Data.Semigroup.Generic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../semigroups/html/src"><span class="hs-identifier">GenericSemigroupMonoid</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../witherable/html/src"><span class="hs-identifier">Witherable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../witherable/html/src"><span class="hs-identifier">Witherable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../witherable/html/src"><span class="hs-identifier">wither</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">{- Note [Inlining approach and 'Secrets of the GHC Inliner']
The approach we take is more-or-less exactly taken from 'Secrets of the GHC Inliner'.

Overall, the cause of differences is that we are largely trying to just clean up some
basic issues, not do serious optimization. In many cases we've already run the GHC simplifier
on our input!

We differ from the paper a few ways, mostly leaving things out:

Functionality
------------

CallSiteInline: TODO in PLT-1146

Inlining recursive bindings: not worth it, complicated.

Context-based inlining: TODO

Beta-reduction: done in `Beta.hs`, not here.

Implementation
--------------

In-scope set: we don't bother keeping it, since we only ever substitute in things that
don't have bound variables.

Suspended substitutions ('SuspEx') for values: we don't need it, because we simplify the RHS before
preInlineUnconditional. For GHC, they can do more simplification in context, but they only want to
process the binding RHS once, so delaying it until the call site is better
if it's a single-occurrence term. But in our case it's fine to leave any improved in-context
simplification to later passes, so we don't need this complication.

Optimization after substituting in DoneExprs: we can't make different inlining decisions
contextually, so there's no point doing this.
-}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">{- Note [The problem of inlining destructors]
Destructors are *perfect* candidates for inlining:

1. They are *always* called fully-saturated, because they are created from pattern matches,
which always provide all the arguments.
2. They will reduce well after being inlined, since their bodies consist of just one argument
applied to the others.

Unfortunately, we can't inline them even after we've eliminated datatypes, because they look like
this (see Note [Abstract data types]):

(/\ ty :: * .
  ...
  -- ty abstract
  \match : &lt;destructor type&gt; .
    &lt;user term&gt;
)
&lt;defn of ty&gt;
...
-- ty concrete
&lt;defn of match&gt;

This doesn't look like a let-binding because there is a type abstraction in between the lambda
and its argument! And this abstraction is important: the body of the matcher only typechecks
if it is *outside* the type abstraction, so we can't just push it inside or something.

We *could* inline 'ty', but this way lies madness: doing that consistently would mean inlining
the definitions of *all* datatypes, which would enormously (exponentially!) bloat the types
inside, making the typechecker (and everything else that processes the AST) incredibly slow.

So it seems that we're stuck. We can't inline destructors in PIR.

But we *can* do it in UPLC! No types, so no problem. The type abstraction/instantiation will
turn into a delay/force pair and get simplified away, and then we have something that we can
inline. This is essentially the reason for the existence of the UPLC inlining pass.
-}</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | Substitution range, 'SubstRng' in the paper but no 'Susp' case.</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner']</span><span>
</span><span id="line-118"></span><span class="hs-keyword">newtype</span><span> </span><span id="InlineTerm"><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-var">InlineTerm</span></a></span></span><span> </span><span id="local-6989586621681118557"><span class="annot"><a href="#local-6989586621681118557"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118556"><span class="annot"><a href="#local-6989586621681118556"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118555"><span class="annot"><a href="#local-6989586621681118555"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118554"><span class="annot"><a href="#local-6989586621681118554"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118553"><span class="annot"><a href="#local-6989586621681118553"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-119"></span><span>    </span><span id="Done"><span class="annot"><a href="PlutusIR.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Rename.Internal.html#Dupable"><span class="hs-identifier hs-type">Dupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118557"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118556"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118555"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118554"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118553"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">--out expressions</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | Term substitution, 'Subst' in the paper.</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- A map of unprocessed variable and its substitution range.</span><span>
</span><span id="line-123"></span><span class="hs-keyword">newtype</span><span> </span><span id="TermEnv"><span class="annot"><a href="PlutusIR.Transform.Inline.html#TermEnv"><span class="hs-identifier hs-var">TermEnv</span></a></span></span><span> </span><span id="local-6989586621681119050"><span class="annot"><a href="#local-6989586621681119050"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681119049"><span class="annot"><a href="#local-6989586621681119049"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681119048"><span class="annot"><a href="#local-6989586621681119048"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681119047"><span class="annot"><a href="#local-6989586621681119047"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681119046"><span class="annot"><a href="#local-6989586621681119046"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>    </span><span id="TermEnv"><span class="annot"><a href="PlutusIR.Transform.Inline.html#TermEnv"><span class="hs-identifier hs-var">TermEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_unTermEnv"><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
-&gt; UniqueMap TermUnique (InlineTerm tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#_unTermEnv"><span class="hs-identifier hs-var hs-var">_unTermEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#UniqueMap"><span class="hs-identifier hs-type">UniqueMap</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119050"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119049"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119048"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119047"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119046"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681118418"><span id="local-6989586621681118424"><span id="local-6989586621681118429"><span class="annot"><span class="annottext">NonEmpty (TermEnv tyname name uni fun a)
-&gt; TermEnv tyname name uni fun a
TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
forall b.
Integral b =&gt;
b -&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall tyname name (uni :: * -&gt; *) fun a.
NonEmpty (TermEnv tyname name uni fun a)
-&gt; TermEnv tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
stimes :: forall b.
Integral b =&gt;
b -&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
$cstimes :: forall tyname name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
sconcat :: NonEmpty (TermEnv tyname name uni fun a)
-&gt; TermEnv tyname name uni fun a
$csconcat :: forall tyname name (uni :: * -&gt; *) fun a.
NonEmpty (TermEnv tyname name uni fun a)
-&gt; TermEnv tyname name uni fun a
&lt;&gt; :: TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
$c&lt;&gt; :: forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681118399"><span id="local-6989586621681118403"><span id="local-6989586621681118408"><span class="annot"><span class="annottext">TermEnv tyname name uni fun a
[TermEnv tyname name uni fun a] -&gt; TermEnv tyname name uni fun a
TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
forall a.
Semigroup a -&gt; a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
forall tyname name (uni :: * -&gt; *) fun a.
Semigroup (TermEnv tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
[TermEnv tyname name uni fun a] -&gt; TermEnv tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
mconcat :: [TermEnv tyname name uni fun a] -&gt; TermEnv tyname name uni fun a
$cmconcat :: forall tyname name (uni :: * -&gt; *) fun a.
[TermEnv tyname name uni fun a] -&gt; TermEnv tyname name uni fun a
mappend :: TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
$cmappend :: forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
-&gt; TermEnv tyname name uni fun a -&gt; TermEnv tyname name uni fun a
mempty :: TermEnv tyname name uni fun a
$cmempty :: forall tyname name (uni :: * -&gt; *) fun a.
TermEnv tyname name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | Type substitution, similar to `TermEnv` but for types.</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- A map of unprocessed type variable and its substitution range.</span><span>
</span><span id="line-129"></span><span class="hs-keyword">newtype</span><span> </span><span id="TypeEnv"><span class="annot"><a href="PlutusIR.Transform.Inline.html#TypeEnv"><span class="hs-identifier hs-var">TypeEnv</span></a></span></span><span> </span><span id="local-6989586621681119017"><span class="annot"><a href="#local-6989586621681119017"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681119016"><span class="annot"><a href="#local-6989586621681119016"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681119015"><span class="annot"><a href="#local-6989586621681119015"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>    </span><span id="TypeEnv"><span class="annot"><a href="PlutusIR.Transform.Inline.html#TypeEnv"><span class="hs-identifier hs-var">TypeEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_unTypeEnv"><span class="annot"><span class="annottext">forall tyname (uni :: * -&gt; *) a.
TypeEnv tyname uni a
-&gt; UniqueMap TypeUnique (Dupable (Type tyname uni a))
</span><a href="PlutusIR.Transform.Inline.html#_unTypeEnv"><span class="hs-identifier hs-var hs-var">_unTypeEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#UniqueMap"><span class="hs-identifier hs-type">UniqueMap</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Rename.Internal.html#Dupable"><span class="hs-identifier hs-type">Dupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119017"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119016"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681119015"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681118381"><span id="local-6989586621681118387"><span id="local-6989586621681118391"><span class="annot"><span class="annottext">NonEmpty (TypeEnv tyname uni a) -&gt; TypeEnv tyname uni a
TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
forall b.
Integral b =&gt;
b -&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall tyname (uni :: * -&gt; *) a.
NonEmpty (TypeEnv tyname uni a) -&gt; TypeEnv tyname uni a
forall tyname (uni :: * -&gt; *) a.
TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
forall tyname (uni :: * -&gt; *) a b.
Integral b =&gt;
b -&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
stimes :: forall b.
Integral b =&gt;
b -&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
$cstimes :: forall tyname (uni :: * -&gt; *) a b.
Integral b =&gt;
b -&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
sconcat :: NonEmpty (TypeEnv tyname uni a) -&gt; TypeEnv tyname uni a
$csconcat :: forall tyname (uni :: * -&gt; *) a.
NonEmpty (TypeEnv tyname uni a) -&gt; TypeEnv tyname uni a
&lt;&gt; :: TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
$c&lt;&gt; :: forall tyname (uni :: * -&gt; *) a.
TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681118364"><span id="local-6989586621681118368"><span id="local-6989586621681118372"><span class="annot"><span class="annottext">TypeEnv tyname uni a
[TypeEnv tyname uni a] -&gt; TypeEnv tyname uni a
TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
forall a.
Semigroup a -&gt; a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
forall tyname (uni :: * -&gt; *) a. Semigroup (TypeEnv tyname uni a)
forall tyname (uni :: * -&gt; *) a. TypeEnv tyname uni a
forall tyname (uni :: * -&gt; *) a.
[TypeEnv tyname uni a] -&gt; TypeEnv tyname uni a
forall tyname (uni :: * -&gt; *) a.
TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
mconcat :: [TypeEnv tyname uni a] -&gt; TypeEnv tyname uni a
$cmconcat :: forall tyname (uni :: * -&gt; *) a.
[TypeEnv tyname uni a] -&gt; TypeEnv tyname uni a
mappend :: TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
$cmappend :: forall tyname (uni :: * -&gt; *) a.
TypeEnv tyname uni a
-&gt; TypeEnv tyname uni a -&gt; TypeEnv tyname uni a
mempty :: TypeEnv tyname uni a
$cmempty :: forall tyname (uni :: * -&gt; *) a. TypeEnv tyname uni a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | Substitution for both terms and types.</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- Similar to 'Subst' in the paper, but the paper only has terms.</span><span>
</span><span id="line-135"></span><span id="local-6989586621681118359"><span id="local-6989586621681118360"></span></span><span class="hs-keyword">data</span><span> </span><span id="Subst"><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span id="local-6989586621681118991"><span class="annot"><a href="#local-6989586621681118991"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118990"><span class="annot"><a href="#local-6989586621681118990"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118989"><span class="annot"><a href="#local-6989586621681118989"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118988"><span class="annot"><a href="#local-6989586621681118988"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118987"><span class="annot"><a href="#local-6989586621681118987"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Subst"><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_termEnv"><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a -&gt; TermEnv tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#_termEnv"><span class="hs-identifier hs-var hs-var">_termEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118991"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118990"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118989"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118988"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118987"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-136"></span><span>                                         </span><span class="hs-special">,</span><span> </span><span id="_typeEnv"><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a -&gt; TypeEnv tyname uni a
</span><a href="PlutusIR.Transform.Inline.html#_typeEnv"><span class="hs-identifier hs-var hs-var">_typeEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#TypeEnv"><span class="hs-identifier hs-type">TypeEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118991"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118989"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118987"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-137"></span><span>                                         </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall tyname name (uni :: * -&gt; *) fun a x.
Rep (Subst tyname name uni fun a) x -&gt; Subst tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a x.
Subst tyname name uni fun a -&gt; Rep (Subst tyname name uni fun a) x
$cto :: forall tyname name (uni :: * -&gt; *) fun a x.
Rep (Subst tyname name uni fun a) x -&gt; Subst tyname name uni fun a
$cfrom :: forall tyname name (uni :: * -&gt; *) fun a x.
Subst tyname name uni fun a -&gt; Rep (Subst tyname name uni fun a) x
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681118335"><span id="local-6989586621681118343"><span id="local-6989586621681118350"><span class="annot"><span class="annottext">NonEmpty (Subst tyname name uni fun a)
-&gt; Subst tyname name uni fun a
Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
forall b.
Integral b =&gt;
b -&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall tyname name (uni :: * -&gt; *) fun a.
NonEmpty (Subst tyname name uni fun a)
-&gt; Subst tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
stimes :: forall b.
Integral b =&gt;
b -&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
$cstimes :: forall tyname name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
sconcat :: NonEmpty (Subst tyname name uni fun a)
-&gt; Subst tyname name uni fun a
$csconcat :: forall tyname name (uni :: * -&gt; *) fun a.
NonEmpty (Subst tyname name uni fun a)
-&gt; Subst tyname name uni fun a
&lt;&gt; :: Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
$c&lt;&gt; :: forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681118281"><span id="local-6989586621681118287"><span id="local-6989586621681118294"><span class="annot"><span class="annottext">Subst tyname name uni fun a
[Subst tyname name uni fun a] -&gt; Subst tyname name uni fun a
Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
forall a.
Semigroup a -&gt; a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
forall tyname name (uni :: * -&gt; *) fun a.
Semigroup (Subst tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
[Subst tyname name uni fun a] -&gt; Subst tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
mconcat :: [Subst tyname name uni fun a] -&gt; Subst tyname name uni fun a
$cmconcat :: forall tyname name (uni :: * -&gt; *) fun a.
[Subst tyname name uni fun a] -&gt; Subst tyname name uni fun a
mappend :: Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
$cmappend :: forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a -&gt; Subst tyname name uni fun a
mempty :: Subst tyname name uni fun a
$cmempty :: forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></a></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../semigroups/html/src"><span class="hs-identifier hs-type">GenericSemigroupMonoid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118991"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118990"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118989"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118988"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118987"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span id="unTermEnv"><span id="local-6989586621681118939"><span id="local-6989586621681118940"><span id="local-6989586621681118941"><span id="local-6989586621681118942"><span id="local-6989586621681118943"><span id="local-6989586621681119046"><span id="local-6989586621681119047"><span id="local-6989586621681119048"><span id="local-6989586621681119049"><span id="local-6989586621681119050"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">TermEnv</span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-142"></span><span id="unTypeEnv"><span id="local-6989586621681118923"><span id="local-6989586621681118924"><span id="local-6989586621681118925"><span id="local-6989586621681119015"><span id="local-6989586621681119016"><span id="local-6989586621681119017"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">TypeEnv</span></span></span></span></span></span></span></span><span>
</span><span id="line-143"></span><span id="typeEnv"><span id="termEnv"><span id="local-6989586621681118916"><span id="local-6989586621681118917"><span id="local-6989586621681118987"><span id="local-6989586621681118988"><span id="local-6989586621681118989"><span id="local-6989586621681118990"><span id="local-6989586621681118991"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Subst</span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-keyword">type</span><span> </span><span id="ExternalConstraints"><span class="annot"><a href="PlutusIR.Transform.Inline.html#ExternalConstraints"><span class="hs-identifier hs-var">ExternalConstraints</span></a></span></span><span> </span><span id="local-6989586621681118212"><span class="annot"><a href="#local-6989586621681118212"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118211"><span class="annot"><a href="#local-6989586621681118211"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118210"><span class="annot"><a href="#local-6989586621681118210"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118209"><span class="annot"><a href="#local-6989586621681118209"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118208"><span class="annot"><a href="#local-6989586621681118208"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118211"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118212"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118211"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118210"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118209"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118208"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-keyword">type</span><span> </span><span id="InliningConstraints"><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-var">InliningConstraints</span></a></span></span><span> </span><span id="local-6989586621681118207"><span class="annot"><a href="#local-6989586621681118207"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118206"><span class="annot"><a href="#local-6989586621681118206"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118205"><span class="annot"><a href="#local-6989586621681118205"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118204"><span class="annot"><a href="#local-6989586621681118204"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118206"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118207"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118206"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118205"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118204"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-keyword">data</span><span> </span><span id="InlineInfo"><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-var">InlineInfo</span></a></span></span><span> </span><span id="local-6989586621681118896"><span class="annot"><a href="#local-6989586621681118896"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118895"><span class="annot"><a href="#local-6989586621681118895"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118894"><span class="annot"><a href="#local-6989586621681118894"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InlineInfo"><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-var">InlineInfo</span></a></span></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_iiStrictnessMap"><span class="annot"><span class="annottext">forall name fun a. InlineInfo name fun a -&gt; StrictnessMap
</span><a href="PlutusIR.Transform.Inline.html#_iiStrictnessMap"><span class="hs-identifier hs-var hs-var">_iiStrictnessMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#StrictnessMap"><span class="hs-identifier hs-type">Deps.StrictnessMap</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- ^ Is it strict? Only needed for PIR, not UPLC</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_iiUsages"><span class="annot"><span class="annottext">forall name fun a. InlineInfo name fun a -&gt; Usages
</span><a href="PlutusIR.Transform.Inline.html#_iiUsages"><span class="hs-identifier hs-var hs-var">_iiUsages</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html#Usages"><span class="hs-identifier hs-type">Usages.Usages</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">-- ^ how many times is it used?</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_iiHints"><span class="annot"><span class="annottext">forall name fun a. InlineInfo name fun a -&gt; InlineHints name a
</span><a href="PlutusIR.Transform.Inline.html#_iiHints"><span class="hs-identifier hs-var hs-var">_iiHints</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.InlineUtils.html#InlineHints"><span class="hs-identifier hs-type">InlineHints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118896"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118894"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- ^ have we explicitly been told to inline.</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_iiBuiltinVer"><span class="annot"><span class="annottext">forall name fun a. InlineInfo name fun a -&gt; BuiltinVersion fun
</span><a href="PlutusIR.Transform.Inline.html#_iiBuiltinVer"><span class="hs-identifier hs-var hs-var">_iiBuiltinVer</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">PLC.BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118895"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- ^ the builtin version.</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-170"></span><span id="iiUsages"><span id="iiStrictnessMap"><span id="iiHints"><span id="iiBuiltinVer"><span id="local-6989586621681118874"><span id="local-6989586621681118875"><span id="local-6989586621681118876"><span id="local-6989586621681118894"><span id="local-6989586621681118895"><span id="local-6989586621681118896"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">InlineInfo</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">-- Using a concrete monad makes a very large difference to the performance of this module</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- (determined from profiling)</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- | The monad the inliner runs in.</span><span>
</span><span id="line-175"></span><span class="hs-keyword">type</span><span> </span><span id="InlineM"><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-var">InlineM</span></a></span></span><span> </span><span id="local-6989586621681118162"><span class="annot"><a href="#local-6989586621681118162"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118161"><span class="annot"><a href="#local-6989586621681118161"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118160"><span class="annot"><a href="#local-6989586621681118160"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118159"><span class="annot"><a href="#local-6989586621681118159"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118158"><span class="annot"><a href="#local-6989586621681118158"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">ReaderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-type">InlineInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118161"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118159"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118158"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118162"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118161"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118160"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118159"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118158"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | Look up the unprocessed variable in the substitution.</span><span>
</span><span id="line-179"></span><span id="local-6989586621681118849"><span id="local-6989586621681118850"><span id="local-6989586621681118851"><span id="local-6989586621681118852"><span id="local-6989586621681118854"><span class="annot"><a href="PlutusIR.Transform.Inline.html#lookupTerm"><span class="hs-identifier hs-type">lookupTerm</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118854"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118854"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-comment">-- ^ The name of the variable.</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118852"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118854"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118851"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118850"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118849"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The substitution.</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118852"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118854"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118851"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118850"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118849"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-184"></span><span id="lookupTerm"><span class="annot"><span class="annottext">lookupTerm :: forall name tyname (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name
-&gt; Subst tyname name uni fun a
-&gt; Maybe (InlineTerm tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#lookupTerm"><span class="hs-identifier hs-var hs-var">lookupTerm</span></a></span></span><span> </span><span id="local-6989586621681118149"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681118149"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681118148"><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name unique a.
HasUnique name unique =&gt;
name -&gt; UniqueMap unique a -&gt; Maybe a
</span><a href="PlutusCore.Name.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681118149"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a name fun.
Lens
  (Subst tyname name uni fun a)
  (Subst tyname name uni fun a)
  (TermEnv tyname name uni fun a)
  (TermEnv tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#termEnv"><span class="hs-identifier hs-var">termEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a tyname name
       (uni :: * -&gt; *) fun a.
Iso
  (TermEnv tyname name uni fun a)
  (TermEnv tyname name uni fun a)
  (UniqueMap TermUnique (InlineTerm tyname name uni fun a))
  (UniqueMap TermUnique (InlineTerm tyname name uni fun a))
</span><a href="PlutusIR.Transform.Inline.html#unTermEnv"><span class="hs-identifier hs-var">unTermEnv</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | Insert the unprocessed variable into the substitution.</span><span>
</span><span id="line-187"></span><span id="local-6989586621681118825"><span id="local-6989586621681118826"><span id="local-6989586621681118827"><span id="local-6989586621681118828"><span id="local-6989586621681118829"><span class="annot"><a href="PlutusIR.Transform.Inline.html#extendTerm"><span class="hs-identifier hs-type">extendTerm</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118829"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118829"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-comment">-- ^ The name of the variable.</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118828"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118829"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118827"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118826"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118825"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The substitution range.</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118828"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118829"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118827"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118826"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118825"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The substitution.</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118828"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118829"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118827"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118826"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118825"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-193"></span><span id="extendTerm"><span class="annot"><span class="annottext">extendTerm :: forall name tyname (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name
-&gt; InlineTerm tyname name uni fun a
-&gt; Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#extendTerm"><span class="hs-identifier hs-var hs-var">extendTerm</span></a></span></span><span> </span><span id="local-6989586621681118137"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681118137"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681118136"><span class="annot"><span class="annottext">InlineTerm tyname name uni fun a
</span><a href="#local-6989586621681118136"><span class="hs-identifier hs-var">clos</span></a></span></span><span> </span><span id="local-6989586621681118135"><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118135"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118135"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a name fun.
Lens
  (Subst tyname name uni fun a)
  (Subst tyname name uni fun a)
  (TermEnv tyname name uni fun a)
  (TermEnv tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#termEnv"><span class="hs-identifier hs-var">termEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a tyname name
       (uni :: * -&gt; *) fun a.
Iso
  (TermEnv tyname name uni fun a)
  (TermEnv tyname name uni fun a)
  (UniqueMap TermUnique (InlineTerm tyname name uni fun a))
  (UniqueMap TermUnique (InlineTerm tyname name uni fun a))
</span><a href="PlutusIR.Transform.Inline.html#unTermEnv"><span class="hs-identifier hs-var">unTermEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">%~</span></a></span><span> </span><span class="annot"><span class="annottext">forall name unique a.
HasUnique name unique =&gt;
name -&gt; a -&gt; UniqueMap unique a -&gt; UniqueMap unique a
</span><a href="PlutusCore.Name.html#insertByName"><span class="hs-identifier hs-var">insertByName</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681118137"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">InlineTerm tyname name uni fun a
</span><a href="#local-6989586621681118136"><span class="hs-identifier hs-var">clos</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Look up the unprocessed type variable in the substitution.</span><span>
</span><span id="line-196"></span><span id="local-6989586621681118804"><span id="local-6989586621681118805"><span id="local-6989586621681118806"><span id="local-6989586621681118807"><span id="local-6989586621681118808"><span class="annot"><a href="PlutusIR.Transform.Inline.html#lookupType"><span class="hs-identifier hs-type">lookupType</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118808"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118808"><span class="hs-identifier hs-type">tyname</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118808"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118807"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118806"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118805"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118804"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Rename.Internal.html#Dupable"><span class="hs-identifier hs-type">Dupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118808"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118806"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118804"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-201"></span><span id="lookupType"><span class="annot"><span class="annottext">lookupType :: forall tyname name (uni :: * -&gt; *) fun a.
HasUnique tyname TypeUnique =&gt;
tyname
-&gt; Subst tyname name uni fun a
-&gt; Maybe (Dupable (Type tyname uni a))
</span><a href="PlutusIR.Transform.Inline.html#lookupType"><span class="hs-identifier hs-var hs-var">lookupType</span></a></span></span><span> </span><span id="local-6989586621681118125"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681118125"><span class="hs-identifier hs-var">tn</span></a></span></span><span> </span><span id="local-6989586621681118124"><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118124"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name unique a.
HasUnique name unique =&gt;
name -&gt; UniqueMap unique a -&gt; Maybe a
</span><a href="PlutusCore.Name.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681118125"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118124"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Lens' (Subst tyname name uni fun a) (TypeEnv tyname uni a)
</span><a href="PlutusIR.Transform.Inline.html#typeEnv"><span class="hs-identifier hs-var">typeEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname (uni :: * -&gt; *) a tyname (uni :: * -&gt; *) a.
Iso
  (TypeEnv tyname uni a)
  (TypeEnv tyname uni a)
  (UniqueMap TypeUnique (Dupable (Type tyname uni a)))
  (UniqueMap TypeUnique (Dupable (Type tyname uni a)))
</span><a href="PlutusIR.Transform.Inline.html#unTypeEnv"><span class="hs-identifier hs-var">unTypeEnv</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- | Check if the type substitution is empty.</span><span>
</span><span id="line-204"></span><span id="local-6989586621681118794"><span id="local-6989586621681118795"><span id="local-6989586621681118796"><span id="local-6989586621681118797"><span id="local-6989586621681118798"><span class="annot"><a href="PlutusIR.Transform.Inline.html#isTypeSubstEmpty"><span class="hs-identifier hs-type">isTypeSubstEmpty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118798"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118797"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118796"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118795"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118794"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-205"></span><span id="isTypeSubstEmpty"><span class="annot"><span class="annottext">isTypeSubstEmpty :: forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#isTypeSubstEmpty"><span class="hs-identifier hs-var hs-var">isTypeSubstEmpty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><span class="annottext">TermEnv tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.Inline.html#TypeEnv"><span class="hs-identifier hs-type">TypeEnv</span></a></span><span> </span><span id="local-6989586621681118122"><span class="annot"><span class="annottext">UniqueMap TypeUnique (Dupable (Type tyname uni a))
</span><a href="#local-6989586621681118122"><span class="hs-identifier hs-var">tyEnv</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall unique a. UniqueMap unique a -&gt; Bool
</span><a href="PlutusCore.Name.html#isEmpty"><span class="hs-identifier hs-var">isEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">UniqueMap TypeUnique (Dupable (Type tyname uni a))
</span><a href="#local-6989586621681118122"><span class="hs-identifier hs-var">tyEnv</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="hs-comment">-- | Insert the unprocessed type variable into the substitution.</span><span>
</span><span id="line-208"></span><span id="local-6989586621681118782"><span id="local-6989586621681118783"><span id="local-6989586621681118784"><span id="local-6989586621681118785"><span id="local-6989586621681118786"><span class="annot"><a href="PlutusIR.Transform.Inline.html#extendType"><span class="hs-identifier hs-type">extendType</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118786"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">TypeUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118786"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="hs-comment">-- ^ The name of the type variable.</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118786"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118785"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118784"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ Its type.</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118786"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118783"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118785"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118782"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118784"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The substitution.</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118786"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118783"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118785"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118782"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118784"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-214"></span><span id="extendType"><span class="annot"><span class="annottext">extendType :: forall tyname (uni :: * -&gt; *) a name fun.
HasUnique tyname TypeUnique =&gt;
tyname
-&gt; Type tyname uni a
-&gt; Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#extendType"><span class="hs-identifier hs-var hs-var">extendType</span></a></span></span><span> </span><span id="local-6989586621681118114"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681118114"><span class="hs-identifier hs-var">tn</span></a></span></span><span> </span><span id="local-6989586621681118113"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681118113"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681118112"><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118112"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst tyname name uni fun a
</span><a href="#local-6989586621681118112"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span>  </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Lens' (Subst tyname name uni fun a) (TypeEnv tyname uni a)
</span><a href="PlutusIR.Transform.Inline.html#typeEnv"><span class="hs-identifier hs-var">typeEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname (uni :: * -&gt; *) a tyname (uni :: * -&gt; *) a.
Iso
  (TypeEnv tyname uni a)
  (TypeEnv tyname uni a)
  (UniqueMap TypeUnique (Dupable (Type tyname uni a)))
  (UniqueMap TypeUnique (Dupable (Type tyname uni a)))
</span><a href="PlutusIR.Transform.Inline.html#unTypeEnv"><span class="hs-identifier hs-var">unTypeEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">%~</span></a></span><span> </span><span class="annot"><span class="annottext">forall name unique a.
HasUnique name unique =&gt;
name -&gt; a -&gt; UniqueMap unique a -&gt; UniqueMap unique a
</span><a href="PlutusCore.Name.html#insertByName"><span class="hs-identifier hs-var">insertByName</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681118114"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681118113"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-comment">{- Note [Inlining and global uniqueness]
Inlining relies on global uniqueness (we store things in a unique map), and *does* currently
preserve it because we don't currently inline anything with binders.

If we do start inlining things with binders in them, we should probably try and preserve it by
doing something like 'The rapier' section from the paper. We could also just bite the bullet
and rename everything when we substitute in, which GHC considers too expensive but we might accept.
-}</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">-- | Inline simple bindings. Relies on global uniqueness, and preserves it.</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- See Note [Inlining and global uniqueness]</span><span>
</span><span id="line-227"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#inline"><span class="hs-identifier hs-type">inline</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118775"><span class="annot"><a href="#local-6989586621681118775"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118774"><span class="annot"><a href="#local-6989586621681118774"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118773"><span class="annot"><a href="#local-6989586621681118773"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118772"><span class="annot"><a href="#local-6989586621681118772"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118769"><span class="annot"><a href="#local-6989586621681118769"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621681118771"><span class="annot"><a href="#local-6989586621681118771"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#ExternalConstraints"><span class="hs-identifier hs-type">ExternalConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118775"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118774"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118773"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118772"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118771"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.InlineUtils.html#InlineHints"><span class="hs-identifier hs-type">InlineHints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118774"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118769"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">PLC.BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118772"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118775"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118774"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118773"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118772"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118769"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118771"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118775"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118774"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118773"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118772"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118769"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span id="inline"><span class="annot"><span class="annottext">inline :: forall tyname name (uni :: * -&gt; *) fun a (m :: * -&gt; *).
ExternalConstraints tyname name uni fun m =&gt;
InlineHints name a
-&gt; BuiltinVersion fun
-&gt; Term tyname name uni fun a
-&gt; m (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#inline"><span class="hs-identifier hs-var hs-var">inline</span></a></span></span><span> </span><span id="local-6989586621681118088"><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681118088"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span id="local-6989586621681118087"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681118087"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span id="local-6989586621681118086"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681118086"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><a href="#local-6989586621681118085"><span class="hs-identifier hs-type">inlineInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-type">InlineInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118774"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118772"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118769"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span id="local-6989586621681118085"><span class="annot"><span class="annottext">inlineInfo :: InlineInfo name fun a
</span><a href="#local-6989586621681118085"><span class="hs-identifier hs-var hs-var">inlineInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name fun a.
StrictnessMap
-&gt; Usages
-&gt; InlineHints name a
-&gt; BuiltinVersion fun
-&gt; InlineInfo name fun a
</span><a href="PlutusIR.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-var">InlineInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">(Graph Node, StrictnessMap)
</span><a href="#local-6989586621681118084"><span class="hs-identifier hs-var">deps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681118083"><span class="hs-identifier hs-var">usgs</span></a></span><span> </span><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681118088"><span class="hs-identifier hs-var">hints</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681118087"><span class="hs-identifier hs-var">ver</span></a></span><span>
</span><span id="line-237"></span><span>        </span><span class="hs-comment">-- We actually just want the variable strictness information here!</span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><a href="#local-6989586621681118084"><span class="hs-identifier hs-type">deps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../algebraic-graphs/html/src"><span class="hs-identifier hs-type">G.Graph</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Node"><span class="hs-identifier hs-type">Deps.Node</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map.Map</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Strictness"><span class="hs-identifier hs-type">Strictness</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>        </span><span id="local-6989586621681118084"><span class="annot"><span class="annottext">deps :: (Graph Node, StrictnessMap)
</span><a href="#local-6989586621681118084"><span class="hs-identifier hs-var hs-var">deps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall g tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
BuiltinVersion fun
-&gt; Term tyname name uni fun a -&gt; (g, StrictnessMap)
</span><a href="PlutusIR.Analysis.Dependencies.html#runTermDeps"><span class="hs-identifier hs-var">Deps.runTermDeps</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681118087"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681118086"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="annot"><a href="#local-6989586621681118083"><span class="hs-identifier hs-type">usgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html#Usages"><span class="hs-identifier hs-type">Usages.Usages</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span id="local-6989586621681118083"><span class="annot"><span class="annottext">usgs :: Usages
</span><a href="#local-6989586621681118083"><span class="hs-identifier hs-var hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name tyname (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, HasUnique tyname TypeUnique) =&gt;
Term tyname name uni fun a -&gt; Usages
</span><a href="PlutusIR.Analysis.Usages.html#termUsages"><span class="hs-identifier hs-var">Usages.termUsages</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681118086"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadQuote m =&gt; Quote a -&gt; m a
</span><a href="PlutusCore.Quote.html#liftQuote"><span class="hs-identifier hs-var">liftQuote</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">runReaderT</span></a></span><span> </span><span class="annot"><span class="annottext">InlineInfo name fun a
</span><a href="#local-6989586621681118085"><span class="hs-identifier hs-var">inlineInfo</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681118086"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">{- Note [Removing inlined bindings]
We *do* remove bindings that we inline (since we only do unconditional inlining). We *could*
leave this to the dead code pass, but it's helpful to do it here.
Crucially, we have to do the same reasoning wrt strict bindings and purity
(see Note [Inlining and purity]):
we can only inline *pure* strict bindings, which is effectively the same as what we do in the dead
code pass.

Annoyingly, this requires us to redo the analysis that we do for the dead binding pass.
TODO: merge them or figure out a way to share more work, especially since there's similar logic.
This might mean reinventing GHC's OccAnal...
-}</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- | Run the inliner on a `Core.Type.Term`.</span><span>
</span><span id="line-258"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-type">processTerm</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118719"><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118718"><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118717"><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118716"><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118715"><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ Term to be processed.</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span id="processTerm"><span class="annot"><span class="annottext">processTerm :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var hs-var">processTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; ReaderT
     (InlineInfo name fun a)
     (StateT (Subst tyname name uni fun a) (QuoteT Identity))
     (Term tyname name uni fun a)
</span><a href="#local-6989586621681118002"><span class="hs-identifier hs-var">handleTerm</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;=&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) s t a b.
LensLike f s t a b -&gt; LensLike f s t a b
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">traverseOf</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Traversal' (Term tyname name uni fun a) (Type tyname uni a)
</span><a href="PlutusIR.Core.Plated.html#termSubtypes"><span class="hs-identifier hs-var">termSubtypes</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
-&gt; InlineM tyname name uni fun a (Type tyname uni a)
</span><a href="#local-6989586621681117998"><span class="hs-identifier hs-var">applyTypeSubstitution</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><a href="#local-6989586621681118002"><span class="hs-identifier hs-type">handleTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621681118002"><span class="annot"><span class="annottext">handleTerm :: Term tyname name uni fun a
-&gt; ReaderT
     (InlineInfo name fun a)
     (StateT (Subst tyname name uni fun a) (QuoteT Identity))
     (Term tyname name uni fun a)
</span><a href="#local-6989586621681118002"><span class="hs-identifier hs-var hs-var">handleTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-267"></span><span>        </span><span id="local-6989586621681117997"><span class="annot"><span class="annottext">v :: Term tyname name uni fun a
</span><a href="#local-6989586621681117997"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117995"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117995"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117997"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">name
-&gt; InlineM
     tyname name uni fun a (Maybe (Term tyname name uni fun a))
</span><a href="#local-6989586621681117992"><span class="hs-identifier hs-var">substName</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117995"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681117990"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117990"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span id="local-6989586621681117988"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681117988"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681117987"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117987"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>            </span><span class="hs-comment">-- Process bindings, eliminating those which will be inlined unconditionally,</span><span>
</span><span id="line-270"></span><span>            </span><span class="hs-comment">-- and accumulating the new substitutions</span><span>
</span><span id="line-271"></span><span>            </span><span class="hs-comment">-- See Note [Removing inlined bindings]</span><span>
</span><span id="line-272"></span><span>            </span><span class="hs-comment">-- Note that we don't *remove* the bindings or scope the state, so the state will carry</span><span>
</span><span id="line-273"></span><span>            </span><span class="hs-comment">-- over into &quot;sibling&quot; terms. This is fine because we have global uniqueness</span><span>
</span><span id="line-274"></span><span>            </span><span class="hs-comment">-- (see Note [Inlining and global uniqueness]), if somewhat wasteful.</span><span>
</span><span id="line-275"></span><span>            </span><span id="local-6989586621681117986"><span class="annot"><span class="annottext">[Binding tyname name uni fun a]
</span><a href="#local-6989586621681117986"><span class="hs-identifier hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Witherable t, Applicative f) =&gt;
(a -&gt; f (Maybe b)) -&gt; t a -&gt; f (t b)
</span><a href="../../../../witherable/html/src"><span class="hs-identifier hs-var">wither</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
-&gt; InlineM
     tyname name uni fun a (Maybe (Binding tyname name uni fun a))
</span><a href="PlutusIR.Transform.Inline.html#processSingleBinding"><span class="hs-identifier hs-var">processSingleBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117987"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681117988"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>            </span><span id="local-6989586621681117983"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117983"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117987"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-277"></span><span>            </span><span class="hs-comment">-- Use 'mkLet': we're using lists of bindings rather than NonEmpty since we might</span><span>
</span><span id="line-278"></span><span>            </span><span class="hs-comment">-- actually have got rid of all of them!</span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a tyname name (uni :: * -&gt; *) fun.
a
-&gt; Recursivity
-&gt; [Binding tyname name uni fun a]
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.MkPir.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117990"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun a]
</span><a href="#local-6989586621681117986"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117983"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-comment">-- We cannot currently soundly do beta for types (see SCP-2570), so we just recognize</span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-comment">-- immediately instantiated type abstractions here directly.</span><span>
</span><span id="line-282"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span> </span><span id="local-6989586621681117981"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span id="local-6989586621681117979"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span id="local-6989586621681117978"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117978"><span class="hs-identifier hs-var">tn</span></a></span></span><span> </span><span id="local-6989586621681117977"><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621681117977"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681117976"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117976"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681117975"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117975"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>            </span><span id="local-6989586621681117974"><span class="annot"><span class="annottext">Maybe (Type tyname uni a)
</span><a href="#local-6989586621681117974"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
tyname
-&gt; Type tyname uni a
-&gt; InlineM tyname name uni fun a (Maybe (Type tyname uni a))
</span><a href="PlutusIR.Transform.Inline.html#maybeAddTySubst"><span class="hs-identifier hs-var">maybeAddTySubst</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117978"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117975"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-284"></span><span>            </span><span id="local-6989586621681117972"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117972"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117976"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-285"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Type tyname uni a)
</span><a href="#local-6989586621681117974"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-286"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681117971"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117971"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">a'</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117978"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621681117977"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117972"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117971"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-287"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Type tyname uni a)
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117972"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-288"></span><span>        </span><span class="hs-comment">-- This includes recursive let terms, we don't even consider inlining them at the moment</span><span>
</span><span id="line-289"></span><span>        </span><span id="local-6989586621681117970"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117970"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) s t a b.
LensLike (WrappedMonad m) s t a b -&gt; s -&gt; (a -&gt; m b) -&gt; m t
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">forMOf</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Term tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#termSubterms"><span class="hs-identifier hs-var">termSubterms</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117970"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><a href="#local-6989586621681117998"><span class="hs-identifier hs-type">applyTypeSubstitution</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621681117998"><span class="annot"><span class="annottext">applyTypeSubstitution :: Type tyname uni a
-&gt; InlineM tyname name uni fun a (Type tyname uni a)
</span><a href="#local-6989586621681117998"><span class="hs-identifier hs-var hs-var">applyTypeSubstitution</span></a></span></span><span> </span><span id="local-6989586621681117967"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117967"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Subst tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#isTypeSubstEmpty"><span class="hs-identifier hs-var">isTypeSubstEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-comment">-- The type substitution is very often empty, and there are lots of types in the program,</span><span>
</span><span id="line-293"></span><span>        </span><span class="hs-comment">-- so this saves a lot of work (determined from profiling)</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117967"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) tyname (uni :: * -&gt; *) ann.
Monad m =&gt;
(tyname -&gt; m (Maybe (Type tyname uni ann)))
-&gt; Type tyname uni ann -&gt; m (Type tyname uni ann)
</span><a href="PlutusCore.Subst.html#typeSubstTyNamesM"><span class="hs-identifier hs-var">typeSubstTyNamesM</span></a></span><span> </span><span class="annot"><span class="annottext">tyname -&gt; InlineM tyname name uni fun a (Maybe (Type tyname uni a))
</span><a href="#local-6989586621681117965"><span class="hs-identifier hs-var">substTyName</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117967"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-comment">-- See Note [Renaming strategy]</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><a href="#local-6989586621681117965"><span class="hs-identifier hs-type">substTyName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621681117965"><span class="annot"><span class="annottext">substTyName :: tyname -&gt; InlineM tyname name uni fun a (Maybe (Type tyname uni a))
</span><a href="#local-6989586621681117965"><span class="hs-identifier hs-var hs-var">substTyName</span></a></span></span><span> </span><span id="local-6989586621681117964"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117964"><span class="hs-identifier hs-var">tyname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
HasUnique tyname TypeUnique =&gt;
tyname
-&gt; Subst tyname name uni fun a
-&gt; Maybe (Dupable (Type tyname uni a))
</span><a href="PlutusIR.Transform.Inline.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117964"><span class="hs-identifier hs-var">tyname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadQuote m, Rename a) =&gt;
Dupable a -&gt; m a
</span><a href="PlutusCore.Rename.html#liftDupable"><span class="hs-identifier hs-var">liftDupable</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- See Note [Renaming strategy]</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="#local-6989586621681117992"><span class="hs-identifier hs-type">substName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621681117992"><span class="annot"><span class="annottext">substName :: name
-&gt; InlineM
     tyname name uni fun a (Maybe (Term tyname name uni fun a))
</span><a href="#local-6989586621681117992"><span class="hs-identifier hs-var hs-var">substName</span></a></span></span><span> </span><span id="local-6989586621681117962"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117962"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name tyname (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name
-&gt; Subst tyname name uni fun a
-&gt; Maybe (InlineTerm tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#lookupTerm"><span class="hs-identifier hs-var">lookupTerm</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117962"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">InlineTerm tyname name uni fun a
-&gt; ReaderT
     (InlineInfo name fun a)
     (StateT (Subst tyname name uni fun a) (QuoteT Identity))
     (Term tyname name uni fun a)
</span><a href="#local-6989586621681117961"><span class="hs-identifier hs-var">renameTerm</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner']</span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><a href="#local-6989586621681117961"><span class="hs-identifier hs-type">renameTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118719"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118718"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118715"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621681117961"><span class="annot"><span class="annottext">renameTerm :: InlineTerm tyname name uni fun a
-&gt; ReaderT
     (InlineInfo name fun a)
     (StateT (Subst tyname name uni fun a) (QuoteT Identity))
     (Term tyname name uni fun a)
</span><a href="#local-6989586621681117961"><span class="hs-identifier hs-var hs-var">renameTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-comment">-- Already processed term, just rename and put it in, don't do any</span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-comment">-- further optimization here.</span><span>
</span><span id="line-309"></span><span>        </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#Done"><span class="hs-identifier hs-type">Done</span></a></span><span> </span><span id="local-6989586621681117960"><span class="annot"><span class="annottext">Dupable (Term tyname name uni fun a)
</span><a href="#local-6989586621681117960"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadQuote m, Rename a) =&gt;
Dupable a -&gt; m a
</span><a href="PlutusCore.Rename.html#liftDupable"><span class="hs-identifier hs-var">liftDupable</span></a></span><span> </span><span class="annot"><span class="annottext">Dupable (Term tyname name uni fun a)
</span><a href="#local-6989586621681117960"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">{- Note [Renaming strategy]
Since we assume global uniqueness, we can take a slightly different approach to
renaming:  we rename the term we are substituting in, instead of renaming
every binder that our substitution encounters, which should guarantee that we
avoid any variable capture.

We rename both terms and types as both may have binders in them.
-}</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- | Run the inliner on a single non-recursive let binding.</span><span>
</span><span id="line-321"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#processSingleBinding"><span class="hs-identifier hs-type">processSingleBinding</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118645"><span class="annot"><a href="#local-6989586621681118645"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118644"><span class="annot"><a href="#local-6989586621681118644"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118643"><span class="annot"><a href="#local-6989586621681118643"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118642"><span class="annot"><a href="#local-6989586621681118642"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118641"><span class="annot"><a href="#local-6989586621681118641"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118645"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118644"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118643"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118642"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118645"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118644"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118643"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118642"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118641"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The body of the let binding.</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118645"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118644"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118643"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118642"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118641"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The binding.</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118645"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118644"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118643"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118642"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118641"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118645"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118644"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118643"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118642"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118641"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span id="processSingleBinding"><span class="annot"><span class="annottext">processSingleBinding :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
-&gt; InlineM
     tyname name uni fun a (Maybe (Binding tyname name uni fun a))
</span><a href="PlutusIR.Transform.Inline.html#processSingleBinding"><span class="hs-identifier hs-var hs-var">processSingleBinding</span></a></span></span><span> </span><span id="local-6989586621681117939"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117939"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span id="local-6989586621681117937"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117937"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681117936"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117936"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621681117935"><span class="annot"><span class="annottext">v :: VarDecl tyname name uni a
</span><a href="#local-6989586621681117935"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#VarDecl"><span class="hs-identifier hs-type">VarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117933"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117933"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681117932"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117932"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>        </span><span id="local-6989586621681117931"><span class="annot"><span class="annottext">Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117931"><span class="hs-identifier hs-var">maybeRhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; a
-&gt; Strictness
-&gt; name
-&gt; Term tyname name uni fun a
-&gt; InlineM
     tyname name uni fun a (Maybe (Term tyname name uni fun a))
</span><a href="PlutusIR.Transform.Inline.html#maybeAddSubst"><span class="hs-identifier hs-var">maybeAddSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117939"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117937"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117936"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117933"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117932"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Strictness
-&gt; VarDecl tyname name uni a
-&gt; Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117937"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117936"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni a
</span><a href="#local-6989586621681117935"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117931"><span class="hs-identifier hs-var">maybeRhs'</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span> </span><span id="local-6989586621681117928"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117928"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681117927"><span class="annot"><span class="annottext">v :: TyVarDecl tyname a
</span><a href="#local-6989586621681117927"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#TyVarDecl"><span class="hs-identifier hs-type">TyVarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117925"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117925"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681117924"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117924"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>        </span><span id="local-6989586621681117923"><span class="annot"><span class="annottext">Maybe (Type tyname uni a)
</span><a href="#local-6989586621681117923"><span class="hs-identifier hs-var">maybeRhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
tyname
-&gt; Type tyname uni a
-&gt; InlineM tyname name uni fun a (Maybe (Type tyname uni a))
</span><a href="PlutusIR.Transform.Inline.html#maybeAddTySubst"><span class="hs-identifier hs-var">maybeAddTySubst</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117925"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117924"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-332"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; TyVarDecl tyname a
-&gt; Type tyname uni a
-&gt; Binding tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-var">TypeBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117928"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a
</span><a href="#local-6989586621681117927"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Type tyname uni a)
</span><a href="#local-6989586621681117923"><span class="hs-identifier hs-var">maybeRhs'</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-comment">-- Just process all the subterms</span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621681117922"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621681117922"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) s t a b.
LensLike (WrappedMonad m) s t a b -&gt; s -&gt; (a -&gt; m b) -&gt; m t
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">forMOf</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Binding tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#bindingSubterms"><span class="hs-identifier hs-var">bindingSubterms</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621681117922"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- | Check against the heuristics we have for inlining and either inline the term binding or not.</span><span>
</span><span id="line-337"></span><span class="hs-comment">-- The arguments to this function are the fields of the `TermBinding` being processed.</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- Nothing means that we are inlining the term:</span><span>
</span><span id="line-339"></span><span class="hs-comment">--   * we have extended the substitution, and</span><span>
</span><span id="line-340"></span><span class="hs-comment">--   * we are removing the binding (hence we return Nothing).</span><span>
</span><span id="line-341"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#maybeAddSubst"><span class="hs-identifier hs-type">maybeAddSubst</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118587"><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118586"><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118585"><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118584"><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118583"><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Strictness"><span class="hs-identifier hs-type">Strictness</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span id="maybeAddSubst"><span class="annot"><span class="annottext">maybeAddSubst :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; a
-&gt; Strictness
-&gt; name
-&gt; Term tyname name uni fun a
-&gt; InlineM
     tyname name uni fun a (Maybe (Term tyname name uni fun a))
</span><a href="PlutusIR.Transform.Inline.html#maybeAddSubst"><span class="hs-identifier hs-var hs-var">maybeAddSubst</span></a></span></span><span> </span><span id="local-6989586621681117896"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117896"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681117895"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117895"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681117894"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117894"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621681117893"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117893"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681117892"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117892"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>    </span><span id="local-6989586621681117891"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117892"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-comment">-- Check whether we've been told specifically to inline this</span><span>
</span><span id="line-353"></span><span>    </span><span id="local-6989586621681117890"><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681117890"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">forall name fun a name a.
Lens
  (InlineInfo name fun a)
  (InlineInfo name fun a)
  (InlineHints name a)
  (InlineHints name a)
</span><a href="PlutusIR.Transform.Inline.html#iiHints"><span class="hs-identifier hs-var">iiHints</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681117888"><span class="annot"><span class="annottext">hinted :: Bool
</span><a href="#local-6989586621681117888"><span class="hs-identifier hs-var hs-var">hinted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name a. InlineHints name a -&gt; a -&gt; name -&gt; Bool
</span><a href="PlutusCore.InlineUtils.html#shouldInline"><span class="hs-identifier hs-var">shouldInline</span></a></span><span> </span><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681117890"><span class="hs-identifier hs-var">hints</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681117895"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117893"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117888"><span class="hs-identifier hs-var">hinted</span></a></span><span> </span><span class="hs-comment">-- if we've been told specifically, then do it right away</span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall b.
InlineTerm tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Maybe b)
</span><a href="#local-6989586621681117886"><span class="hs-identifier hs-var">extendAndDrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Dupable (Term tyname name uni fun a)
-&gt; InlineTerm tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>        </span><span id="local-6989586621681117885"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117885"><span class="hs-identifier hs-var">termIsPure</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#checkPurity"><span class="hs-identifier hs-var">checkPurity</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-360"></span><span>        </span><span id="local-6989586621681117883"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117883"><span class="hs-identifier hs-var">preUnconditional</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a1 a2 r.
Monad m =&gt;
(a1 -&gt; a2 -&gt; r) -&gt; m a1 -&gt; m a2 -&gt; m r
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">liftM2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">(&amp;&amp;)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
name -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#nameUsedAtMostOnce"><span class="hs-identifier hs-var">nameUsedAtMostOnce</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117893"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; Strictness -&gt; name -&gt; Bool -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#effectSafe"><span class="hs-identifier hs-var">effectSafe</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117896"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117894"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117893"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117885"><span class="hs-identifier hs-var">termIsPure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>        </span><span class="hs-comment">-- similar to the paper, preUnconditional inlining checks that the binder is 'OnceSafe'.</span><span>
</span><span id="line-362"></span><span>        </span><span class="hs-comment">-- I.e., it's used at most once AND it neither duplicate code or work.</span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-comment">-- While we don't check for lambda etc like in the paper, `effectSafe` ensures that it</span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-comment">-- isn't doing any substantial work.</span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-comment">-- We actually also inline 'Dead' binders (i.e., remove dead code) here.</span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117883"><span class="hs-identifier hs-var">preUnconditional</span></a></span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall b.
InlineTerm tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Maybe b)
</span><a href="#local-6989586621681117886"><span class="hs-identifier hs-var">extendAndDrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Dupable (Term tyname name uni fun a)
-&gt; InlineTerm tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-369"></span><span>            </span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner'] and [Inlining and</span><span>
</span><span id="line-370"></span><span>            </span><span class="hs-comment">-- purity]. This is the case where we don't know that the number of occurrences is</span><span>
</span><span id="line-371"></span><span>            </span><span class="hs-comment">-- exactly one, so there's no point checking if the term is immediately evaluated.</span><span>
</span><span id="line-372"></span><span>            </span><span id="local-6989586621681117878"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117878"><span class="hs-identifier hs-var">postUnconditional</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">(&amp;&amp;)</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117885"><span class="hs-identifier hs-var">termIsPure</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#acceptable"><span class="hs-identifier hs-var">acceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117878"><span class="hs-identifier hs-var">postUnconditional</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall b.
InlineTerm tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Maybe b)
</span><a href="#local-6989586621681117886"><span class="hs-identifier hs-var">extendAndDrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Dupable (Term tyname name uni fun a)
-&gt; InlineTerm tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><a href="#local-6989586621681117886"><span class="hs-identifier hs-type">extendAndDrop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-378"></span><span>            </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118558"><span class="annot"><a href="#local-6989586621681118558"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-379"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118587"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118586"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118585"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118584"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118583"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118558"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621681117886"><span class="annot"><span class="annottext">extendAndDrop :: forall b.
InlineTerm tyname name uni fun a
-&gt; InlineM tyname name uni fun a (Maybe b)
</span><a href="#local-6989586621681117886"><span class="hs-identifier hs-var hs-var">extendAndDrop</span></a></span></span><span> </span><span id="local-6989586621681117871"><span class="annot"><span class="annottext">InlineTerm tyname name uni fun a
</span><a href="#local-6989586621681117871"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">modify'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name tyname (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name
-&gt; InlineTerm tyname name uni fun a
-&gt; Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#extendTerm"><span class="hs-identifier hs-var">extendTerm</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117893"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">InlineTerm tyname name uni fun a
</span><a href="#local-6989586621681117871"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-comment">-- | Check if term is pure. See Note [Inlining and purity]</span><span>
</span><span id="line-383"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#checkPurity"><span class="hs-identifier hs-type">checkPurity</span></a></span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118552"><span class="annot"><a href="#local-6989586621681118552"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118551"><span class="annot"><a href="#local-6989586621681118551"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118550"><span class="annot"><a href="#local-6989586621681118550"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118549"><span class="annot"><a href="#local-6989586621681118549"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118548"><span class="annot"><a href="#local-6989586621681118548"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118552"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118551"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118550"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118549"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-glyph">=&gt;</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118552"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118551"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118550"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118549"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118548"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118552"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118551"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118550"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118549"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118548"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-386"></span><span id="checkPurity"><span class="annot"><span class="annottext">checkPurity :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#checkPurity"><span class="hs-identifier hs-var hs-var">checkPurity</span></a></span></span><span> </span><span id="local-6989586621681117848"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117848"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-387"></span><span>    </span><span id="local-6989586621681117847"><span class="annot"><span class="annottext">StrictnessMap
</span><a href="#local-6989586621681117847"><span class="hs-identifier hs-var">strctMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">forall name fun a. Lens' (InlineInfo name fun a) StrictnessMap
</span><a href="PlutusIR.Transform.Inline.html#iiStrictnessMap"><span class="hs-identifier hs-var">iiStrictnessMap</span></a></span><span>
</span><span id="line-388"></span><span>    </span><span id="local-6989586621681117846"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681117846"><span class="hs-identifier hs-var">builtinVer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">forall name fun a fun.
Lens
  (InlineInfo name fun a)
  (InlineInfo name fun a)
  (BuiltinVersion fun)
  (BuiltinVersion fun)
</span><a href="PlutusIR.Transform.Inline.html#iiBuiltinVer"><span class="hs-identifier hs-var">iiBuiltinVer</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681117845"><span class="annot"><span class="annottext">strictnessFun :: name -&gt; Strictness
</span><a href="#local-6989586621681117845"><span class="hs-identifier hs-var hs-var">strictnessFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681117844"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117844"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.findWithDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117844"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StrictnessMap
</span><a href="#local-6989586621681117847"><span class="hs-identifier hs-var">strctMap</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun name tyname a.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun
-&gt; (name -&gt; Strictness) -&gt; Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Purity.html#isPure"><span class="hs-identifier hs-var">isPure</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681117846"><span class="hs-identifier hs-var">builtinVer</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Strictness
</span><a href="#local-6989586621681117845"><span class="hs-identifier hs-var">strictnessFun</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117848"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#nameUsedAtMostOnce"><span class="hs-identifier hs-type">nameUsedAtMostOnce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118543"><span class="annot"><a href="#local-6989586621681118543"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118542"><span class="annot"><a href="#local-6989586621681118542"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118541"><span class="annot"><a href="#local-6989586621681118541"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118540"><span class="annot"><a href="#local-6989586621681118540"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118539"><span class="annot"><a href="#local-6989586621681118539"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118543"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118542"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118541"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118540"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118542"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118543"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118542"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118541"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118540"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118539"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-395"></span><span id="nameUsedAtMostOnce"><span class="annot"><span class="annottext">nameUsedAtMostOnce :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
name -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#nameUsedAtMostOnce"><span class="hs-identifier hs-var hs-var">nameUsedAtMostOnce</span></a></span></span><span> </span><span id="local-6989586621681117825"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117825"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621681117824"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681117824"><span class="hs-identifier hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">forall name fun a. Lens' (InlineInfo name fun a) Usages
</span><a href="PlutusIR.Transform.Inline.html#iiUsages"><span class="hs-identifier hs-var">iiUsages</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-comment">-- 'inlining' terms used 0 times is a cheap way to remove dead code while we're here</span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall n unique. HasUnique n unique =&gt; n -&gt; Usages -&gt; Int
</span><a href="PlutusIR.Analysis.Usages.html#getUsageCount"><span class="hs-identifier hs-var">Usages.getUsageCount</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117825"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681117824"><span class="hs-identifier hs-var">usgs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#effectSafe"><span class="hs-identifier hs-type">effectSafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118538"><span class="annot"><a href="#local-6989586621681118538"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118537"><span class="annot"><a href="#local-6989586621681118537"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118536"><span class="annot"><a href="#local-6989586621681118536"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118535"><span class="annot"><a href="#local-6989586621681118535"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118534"><span class="annot"><a href="#local-6989586621681118534"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118538"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118537"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118536"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118535"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118538"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118537"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118536"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118535"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118534"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Strictness"><span class="hs-identifier hs-type">Strictness</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118537"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-comment">-- ^ is it pure?</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118538"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118537"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118536"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118535"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118534"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-406"></span><span id="effectSafe"><span class="annot"><span class="annottext">effectSafe :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
Term tyname name uni fun a
-&gt; Strictness -&gt; name -&gt; Bool -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#effectSafe"><span class="hs-identifier hs-var hs-var">effectSafe</span></a></span></span><span> </span><span id="local-6989586621681117812"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117812"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681117811"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117811"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621681117810"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117810"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681117809"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117809"><span class="hs-identifier hs-var">purity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-comment">-- This can in the worst case traverse a lot of the term, which could lead to us</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-comment">-- doing ~quadratic work as we process the program. However in practice most term</span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-comment">-- types will make it give up, so it's not too bad.</span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681117808"><span class="annot"><span class="annottext">immediatelyEvaluated :: Bool
</span><a href="#local-6989586621681117808"><span class="hs-identifier hs-var hs-var">immediatelyEvaluated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#firstEffectfulTerm"><span class="hs-identifier hs-var">firstEffectfulTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117812"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-411"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117806"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117806"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117810"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681117806"><span class="hs-identifier hs-var">n'</span></a></span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Term tyname name uni fun a)
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681117811"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-414"></span><span>        </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117809"><span class="hs-identifier hs-var">purity</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117808"><span class="hs-identifier hs-var">immediatelyEvaluated</span></a></span><span>
</span><span id="line-415"></span><span>        </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="hs-comment">-- | Should we inline? Should only inline things that won't duplicate work or code.</span><span>
</span><span id="line-418"></span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner']</span><span>
</span><span id="line-419"></span><span id="local-6989586621681118529"><span id="local-6989586621681118530"><span id="local-6989586621681118531"><span id="local-6989586621681118532"><span id="local-6989586621681118533"><span class="annot"><a href="PlutusIR.Transform.Inline.html#acceptable"><span class="hs-identifier hs-type">acceptable</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118533"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118532"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118531"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118530"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118529"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118533"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118532"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118531"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118530"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118529"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-420"></span><span id="acceptable"><span class="annot"><span class="annottext">acceptable :: forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; InlineM tyname name uni fun a Bool
</span><a href="PlutusIR.Transform.Inline.html#acceptable"><span class="hs-identifier hs-var hs-var">acceptable</span></a></span></span><span> </span><span id="local-6989586621681117797"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117797"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-comment">-- See Note [Inlining criteria]</span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#costIsAcceptable"><span class="hs-identifier hs-var">costIsAcceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117797"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-var">sizeIsAcceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117797"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">{- |
Try to identify the first sub term which will be evaluated in the given term and
which could have an effect. 'Nothing' indicates that we don't know, this function
is conservative.
-}</span><span>
</span><span id="line-429"></span><span id="local-6989586621681118490"><span id="local-6989586621681118491"><span id="local-6989586621681118492"><span id="local-6989586621681118493"><span id="local-6989586621681118494"><span class="annot"><a href="PlutusIR.Transform.Inline.html#firstEffectfulTerm"><span class="hs-identifier hs-type">firstEffectfulTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118494"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118493"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118492"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118491"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118490"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118494"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118493"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118492"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118491"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118490"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-430"></span><span id="firstEffectfulTerm"><span class="annot"><span class="annottext">firstEffectfulTerm :: forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.Inline.html#firstEffectfulTerm"><span class="hs-identifier hs-var hs-var">firstEffectfulTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-432"></span><span>      </span><span id="local-6989586621681117794"><span class="annot"><span class="annottext">goTerm :: Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var hs-var">goTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span id="local-6989586621681117793"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681117793"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681117792"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117792"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
[Binding tyname name uni fun a]
-&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117791"><span class="hs-identifier hs-var">goBindings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. NonEmpty a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681117793"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-434"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681117789"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117789"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117789"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-435"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Term tyname name uni fun a)
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117792"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117787"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117787"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117787"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-438"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117786"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117786"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117786"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-439"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-type">IWrap</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117784"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117784"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117784"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-type">Unwrap</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117782"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117782"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117782"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>        </span><span id="local-6989586621681117781"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621681117781"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117781"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-443"></span><span>        </span><span id="local-6989586621681117780"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621681117780"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117780"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span id="local-6989586621681117778"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621681117778"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117778"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-comment">-- Hard to know what gets evaluated first in a recursive let-binding,</span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-comment">-- just give up and say nothing</span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-449"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-450"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>      </span><span id="local-6989586621681118469"><span id="local-6989586621681118470"><span id="local-6989586621681118471"><span id="local-6989586621681118472"><span id="local-6989586621681118473"><span class="annot"><a href="#local-6989586621681117791"><span class="hs-identifier hs-type">goBindings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118473"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118472"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118471"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118470"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118469"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118473"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118472"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118471"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118470"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118469"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-454"></span><span>      </span><span id="local-6989586621681117791"><span class="annot"><span class="annottext">goBindings :: forall tyname name (uni :: * -&gt; *) fun a.
[Binding tyname name uni fun a]
-&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117791"><span class="hs-identifier hs-var hs-var">goBindings</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><a href="#local-6989586621681117791"><span class="hs-identifier hs-var">goBindings</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681117773"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621681117773"><span class="hs-identifier hs-var">b</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621681117772"><span class="annot"><span class="annottext">[Binding tyname name uni fun a]
</span><a href="#local-6989586621681117772"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621681117773"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-comment">-- Only strict term bindings can cause effects</span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681117771"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117771"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117794"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681117771"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
[Binding tyname name uni fun a]
-&gt; Maybe (Term tyname name uni fun a)
</span><a href="#local-6989586621681117791"><span class="hs-identifier hs-var">goBindings</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun a]
</span><a href="#local-6989586621681117772"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">{- Note [Inlining criteria]
What gets inlined? Our goals are simple:
- Make the resulting program faster (or at least no slower)
- Make the resulting program smaller (or at least no bigger)
- Inline as much as we can, since it exposes optimization opportunities

There are two easy cases:
- Inlining approximately variable-sized and variable-costing terms (e.g. builtins, other variables)
- Inlining single-use terms

After that it gets more difficult. As soon as we're inlining things that are not variable-sized
and are used more than once, we are at risk of doing more work or making things bigger.

There are a few things we could do to do this in a more principled way, such as call-site inlining
based on whether a function is fully applied.
-}</span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-comment">{- Note [Inlining and purity]
When can we inline something that might have effects? We must remember that we often also
remove a binding that we inline.

For strict bindings, the answer is that we can't: we will delay the effects to the use site,
so they may happen multiple times (or none). So we can only inline bindings whose RHS is pure,
or if we can prove that the effects don't change. We take a conservative view on this,
saying that no effects change if:
- The variable is clearly the first possibly-effectful term evaluated in the body
- The variable is used exactly once (so we won't duplicate or remove effects)

For non-strict bindings, the effects already happened at the use site, so it's fine to inline it
unconditionally.
-}</span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span class="hs-comment">-- | Check against the inlining heuristics for types and either inline it, returning Nothing, or</span><span>
</span><span id="line-493"></span><span class="hs-comment">-- just return the type without inlining.</span><span>
</span><span id="line-494"></span><span class="hs-comment">-- We only inline if (1) the type is used at most once OR (2) it's a `trivialType`.</span><span>
</span><span id="line-495"></span><span class="annot"><a href="PlutusIR.Transform.Inline.html#maybeAddTySubst"><span class="hs-identifier hs-type">maybeAddTySubst</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681118630"><span class="annot"><a href="#local-6989586621681118630"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681118629"><span class="annot"><a href="#local-6989586621681118629"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681118628"><span class="annot"><a href="#local-6989586621681118628"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681118627"><span class="annot"><a href="#local-6989586621681118627"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681118626"><span class="annot"><a href="#local-6989586621681118626"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118629"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118628"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118627"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681118630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="hs-comment">-- ^ The type variable</span><span>
</span><span id="line-498"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118628"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118626"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^  The value of the type variable.</span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118629"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118628"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118627"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118626"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118628"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118626"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span id="maybeAddTySubst"><span class="annot"><span class="annottext">maybeAddTySubst :: forall tyname name (uni :: * -&gt; *) fun a.
InliningConstraints tyname name uni fun =&gt;
tyname
-&gt; Type tyname uni a
-&gt; InlineM tyname name uni fun a (Maybe (Type tyname uni a))
</span><a href="PlutusIR.Transform.Inline.html#maybeAddTySubst"><span class="hs-identifier hs-var hs-var">maybeAddTySubst</span></a></span></span><span> </span><span id="local-6989586621681117749"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117749"><span class="hs-identifier hs-var">tn</span></a></span></span><span> </span><span id="local-6989586621681117748"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117748"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>    </span><span id="local-6989586621681117747"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681117747"><span class="hs-identifier hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">forall name fun a. Lens' (InlineInfo name fun a) Usages
</span><a href="PlutusIR.Transform.Inline.html#iiUsages"><span class="hs-identifier hs-var">iiUsages</span></a></span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- No need for multiple phases here</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681117746"><span class="annot"><span class="annottext">typeUsedAtMostOnce :: Bool
</span><a href="#local-6989586621681117746"><span class="hs-identifier hs-var hs-var">typeUsedAtMostOnce</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n unique. HasUnique n unique =&gt; n -&gt; Usages -&gt; Int
</span><a href="PlutusIR.Analysis.Usages.html#getUsageCount"><span class="hs-identifier hs-var">Usages.getUsageCount</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117749"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681117747"><span class="hs-identifier hs-var">usgs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681117746"><span class="hs-identifier hs-var">typeUsedAtMostOnce</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname (uni :: * -&gt; *) a. Type tyname uni a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#trivialType"><span class="hs-identifier hs-var">trivialType</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117748"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-506"></span><span>        </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">modify'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname (uni :: * -&gt; *) a name fun.
HasUnique tyname TypeUnique =&gt;
tyname
-&gt; Type tyname uni a
-&gt; Subst tyname name uni fun a
-&gt; Subst tyname name uni fun a
</span><a href="PlutusIR.Transform.Inline.html#extendType"><span class="hs-identifier hs-var">extendType</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681117749"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117748"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681117748"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="hs-comment">-- | Is the cost increase (in terms of evaluation work) of inlining a variable whose RHS is</span><span>
</span><span id="line-511"></span><span class="hs-comment">-- the given term acceptable?</span><span>
</span><span id="line-512"></span><span id="local-6989586621681118479"><span id="local-6989586621681118480"><span id="local-6989586621681118481"><span id="local-6989586621681118482"><span id="local-6989586621681118483"><span class="annot"><a href="PlutusIR.Transform.Inline.html#costIsAcceptable"><span class="hs-identifier hs-type">costIsAcceptable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118483"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118482"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118481"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118480"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118479"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-513"></span><span id="costIsAcceptable"><span class="annot"><span class="annottext">costIsAcceptable :: forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#costIsAcceptable"><span class="hs-identifier hs-var hs-var">costIsAcceptable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-514"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-517"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-comment">-- This will mean that we create closures at each use site instead of</span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-comment">-- once, but that's a very low cost which we're okay rounding to 0.</span><span>
</span><span id="line-520"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-comment">-- Arguably we could allow these two, but they're uncommon anyway</span><span>
</span><span id="line-524"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-type">IWrap</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-type">Unwrap</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-528"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-529"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span class="hs-comment">-- | Is the size increase (in the AST) of inlining a variable whose RHS is</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- the given term acceptable?</span><span>
</span><span id="line-533"></span><span id="local-6989586621681117740"><span id="local-6989586621681117741"><span id="local-6989586621681117742"><span id="local-6989586621681117743"><span id="local-6989586621681117744"><span class="annot"><a href="PlutusIR.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-type">sizeIsAcceptable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681117744"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681117743"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681117742"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681117741"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681117740"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-534"></span><span id="sizeIsAcceptable"><span class="annot"><span class="annottext">sizeIsAcceptable :: forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-var hs-var">sizeIsAcceptable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-535"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-536"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-537"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-538"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-539"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-comment">-- Arguably we could allow these two, but they're uncommon anyway</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-type">IWrap</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-type">Unwrap</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-comment">-- Constants can be big! We could check the size here and inline if they're</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-comment">-- small, but probably not worth it</span><span>
</span><span id="line-546"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-547"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-548"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-549"></span><span>  </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="hs-comment">-- | Is this a an utterly trivial type which might as well be inlined?</span><span>
</span><span id="line-552"></span><span id="local-6989586621681118455"><span id="local-6989586621681118456"><span id="local-6989586621681118457"><span class="annot"><a href="PlutusIR.Transform.Inline.html#trivialType"><span class="hs-identifier hs-type">trivialType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118457"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118456"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681118455"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span><span>
</span><span id="line-553"></span><span id="trivialType"><span class="annot"><span class="annottext">trivialType :: forall tyname (uni :: * -&gt; *) a. Type tyname uni a -&gt; Bool
</span><a href="PlutusIR.Transform.Inline.html#trivialType"><span class="hs-identifier hs-var hs-var">trivialType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-554"></span><span>    </span><span class="annot"><a href="PlutusCore.Core.Type.html#TyBuiltin"><span class="hs-identifier hs-type">TyBuiltin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-555"></span><span>    </span><span class="annot"><a href="PlutusCore.Core.Type.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-557"></span></pre></body></html>